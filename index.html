<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RowToRecord v1.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <h1>RowToRecord v1.0</h1>
        <div class="mb-3">
            <label for="templateFile" class="form-label">Excel Template Workbook</label>
            <input class="form-control" type="file" id="templateFile" required accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsm">
            <div class="invalid-feedback">
                Something gone wrong with this file
            </div>
        </div>
        <div class="mb-3">
            <label for="sourceFile" class="form-label">Excel Source Workbook</label>
            <input class="form-control" type="file" id="sourceFile" required accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsm">
            <div class="invalid-feedback">
                Something gone wrong with this file
            </div>
        </div>
        <div class="mb-3">
            <label for="configurationFile" class="form-label">Configuration file</label>
            <input class="form-control" type="file" id="configurationFile" required accept=".yaml">
            <div class="invalid-feedback">
                Something gone wrong with this file
            </div>
        </div>
        <label for="generatedFile" class="form-label">Generated file name</label>
        <div class="input-group mb-3">
            <input class="form-control" type="text" id="generatedFile" required placeholder="Generated file name">
            <span class="input-group-text" id="generatedFileExt">.xlsx</span>
        </div>

        <button class="btn btn-primary" onclick="converter()">Generate file</button>
        <div class="mb-3">
            <div id="err"></div>
        </div>
    </div>

    <script type="text/javascript">
        "use strict"; let store = Object.create(null); const handleConfiguration = async e => { try { inputReset(e.target); let t = e.target.files[0]; if (!t) throw "File not found"; let r = await readFileAsText(t), n = parseYaml(r); if (!n) throw "Configuration file not found"; store.configuration = n; let { generatedFileName: o } = n; if (o) { store.generatedFile = o; let { extension: i, name: l } = getFileNameExtension(o); l && i && (document.querySelector("#generatedFile").value = l, document.getElementById("generatedFile").disabled = !0, document.getElementById("generatedFileExt").innerHTML = `.${i}`) } e.target.classList.add("is-valid") } catch (a) { e.target.classList.add("is-invalid"), e.target.nextElementSibling.innerHTML = `Error : ${a}` } }, getWorkbook = async (e, t) => { try { let r = e.target.files[0]; if (!r) throw Error("Error: File not found"); try { let n = await XlsxPopulate.fromDataAsync(r); if (!n) throw Error("Error: Data not found"); e.target.classList.add("is-valid"); let { extension: o } = getFileNameExtension(r.name); if (!o) throw Error("Invalid file extension"); t(n, o) } catch (i) { throw Error("Error: Something went wrong with this file") } } catch (l) { e.target.classList.add("is-invalid"), e.target.nextElementSibling.innerHTML = `${l.message}` } }; async function converter() { try { if (!store.templateWorkbook) throw document.querySelector("#templateFile").classList.add("is-invalid"), "Template file not found"; if (!store.sourceWorkbook) throw document.querySelector("#sourceFile").classList.add("is-invalid"), "Source file not found"; if (!store.configuration) throw document.querySelector("#configurationFile").classList.add("is-invalid"), "Mapping file not found"; if (!store.generatedFile) throw document.querySelector("#generatedFile").classList.add("is-invalid"), "Generated file name not found"; let { sheets: e, modelSheetName: t } = store.configuration; Object.values(e).map(e => { try { let { sheet: { name: r, startRow: n, stopRow: o, referenceColumn: i, mapping: l } } = e; if (!t) throw SyntaxError("Missing model sheet name parameter"); let a = store.templateWorkbook.sheet(t); if (!a) throw SyntaxError(`Model sheet name '${t}' not found`); if (!r) throw SyntaxError("Missing source sheet name parameter"); let s = store.sourceWorkbook.sheet(r); if (!s) throw SyntaxError(`Source sheet name '${r}' not found`); let d = o ?? s._rows.length; if (!n) throw "Missing start row parameter"; if (!i) throw "Missing reference column parameter"; for (let c = n; c < d; c++) { let u = s.row(c).cell(i).value(); if (!u) break; let g = store.templateWorkbook.cloneSheet(a, u); Object.values(l).map(e => { g.cell(e.target).value(s.row(c).cell(e.source).value()) }), g.activeCell("A1") } } catch (f) { throw document.getElementById("err").innerHTML = f, f } }), generate(store.templateWorkbook).then(e => { var t = window.URL.createObjectURL(e), r = document.createElement("a"); document.body.appendChild(r), r.href = t, r.download = store.generatedFile, r.click(), window.URL.revokeObjectURL(t), document.body.removeChild(r), resetForm() }) } catch (r) { document.getElementById("err").innerHTML = r } } document.querySelector("#templateFile").addEventListener("change", e => { getWorkbook(e, (e, t) => { store.templateWorkbook = e, store.extension = t, document.getElementById("generatedFileExt").innerHTML = `.${t}` }) }), document.querySelector("#sourceFile").addEventListener("change", e => { getWorkbook(e, e => { store.sourceWorkbook = e }) }), document.querySelector("#configurationFile").addEventListener("change", handleConfiguration), document.querySelector("#generatedFile").addEventListener("change", e => { store.generatedFile = store.extension ? `${e.target.value}.${store.extension}` : e.target.value }); const generate = e => e.outputAsync(), parseYaml = e => jsyaml.load(e), readFileAsText = e => { let t = new FileReader; return new Promise((r, n) => { t.onerror = () => { t.abort(), n(new DOMException("Problem parsing input file.")) }, t.onload = () => { r(t.result) }, t.readAsText(e) }) }, inputReset = e => { e.classList.remove("is-invalid"), e.classList.remove("is-valid") }, resetForm = () => { document.getElementById("err").innerHTML = "", document.getElementById("generatedFile").disabled = !1, document.getElementById("generatedFileExt").innerHTML = ".xlsx"; let e = document.getElementById("templateFile"), t = document.getElementById("sourceFile"), r = document.getElementById("configurationFile"), n = document.getElementById("generatedFile"); e.value = e.defaultValue, t.value = t.defaultValue, n.value = n.defaultValue, r.value = r.defaultValue, inputReset(e), inputReset(t), inputReset(n), inputReset(r), store = {} }, getFileNameExtension = e => { let t = e.lastIndexOf("."); if (-1 == t) throw SyntaxError("Missing extension file"); let r = e.slice(t + 1), n = e.slice(0, t); return { filename: e, extension: r, name: n } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate-no-encryption.min.js" integrity="sha256-EZ1GG/SOpLQwZR472G3ma/0x00lcEEs2QaeCtwLBp6I=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" integrity="sha256-Rdw90D3AegZwWiwpibjH9wkBPwS9U4bjJ51ORH8H69c=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js" integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz" crossorigin="anonymous"></script>
</body>

</html>